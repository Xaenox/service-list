stages:
  - test
  - build
  - code-review
  - code-quality

variables:
  GRADLE_OPTS: "-Dorg.gradle.daemon=false"
  GRADLE_USER_HOME: "$CI_PROJECT_DIR/.gradle"

cache:
  key: "${CI_COMMIT_REF_SLUG}"
  paths:
    - .gradle/wrapper
    - .gradle/caches

# Тесты backend
test:
  stage: test
  image: eclipse-temurin:17-jdk
  services:
    - name: postgres:16
      alias: postgres
  variables:
    POSTGRES_DB: community_services_test
    POSTGRES_USER: postgres
    POSTGRES_PASSWORD: test_password
    DATABASE_URL: jdbc:postgresql://postgres:5432/community_services_test
    DATABASE_USER: postgres
    DATABASE_PASSWORD: test_password
    JWT_SECRET: test-jwt-secret-for-ci-minimum-32-characters-long
    VAS3K_CLIENT_ID: test_client_id
    VAS3K_CLIENT_SECRET: test_client_secret
    OAUTH_REDIRECT_URL: http://localhost:8080/api/v1/auth/callback
  before_script:
    - chmod +x gradlew
  script:
    - ./gradlew test --no-daemon
  artifacts:
    when: always
    paths:
      - build/test-results/test/**/*.xml
      - build/reports/tests/test/
    reports:
      junit: build/test-results/test/**/TEST-*.xml
    expire_in: 1 week
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_COMMIT_BRANCH == "develop"

# Сборка backend
build:
  stage: build
  image: eclipse-temurin:17-jdk
  needs:
    - test
  before_script:
    - chmod +x gradlew
  script:
    - ./gradlew build -x test --no-daemon
  artifacts:
    paths:
      - build/libs/*.jar
    expire_in: 1 week
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_COMMIT_BRANCH == "develop"

# Автоматическое code review с Claude
claude-review:
  stage: code-review
  image: python:3.11-slim
  before_script:
    - pip install anthropic requests python-gitlab
  script:
    - python .gitlab/scripts/claude-review.py
  allow_failure: true
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
  variables:
    GIT_DEPTH: 0  # Полный клон для анализа изменений

# Проверка качества кода
code-quality:
  stage: code-quality
  image: eclipse-temurin:17-jdk
  before_script:
    - chmod +x gradlew
  script:
    - ./gradlew ktlintCheck --no-daemon || true
    - ./gradlew dependencies --no-daemon
  allow_failure: true
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

# Frontend тесты (если есть)
frontend-test:
  stage: test
  image: node:18
  before_script:
    - cd frontend
    - npm ci
  script:
    - npm run lint || true
    - npm run build
  cache:
    key: "${CI_COMMIT_REF_SLUG}-frontend"
    paths:
      - frontend/node_modules/
  artifacts:
    paths:
      - frontend/dist/
    expire_in: 1 week
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      changes:
        - frontend/**/*
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      changes:
        - frontend/**/*
